{{ block title }}

<div class="block-header">
    {{ button_block|safe }} 1
</div>

<p style="text-align: center; font-size: 26px; margin-bottom: 4px; "> {{ button_decision|safe }} {{player.round_number}} </p>

<div style="display: flex; justify-content: center">
    <label>
        <progress value="{{ participant.progress }}" max="{{ total_pages }}">
        </progress>
    </label>
</div>


{{ endblock }}
{{ block content }}


<html>
<head>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

    {% load static %}
    <link rel="stylesheet" href="{% static 'shared_styles.css' %}">

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>

/////////// global variables

    //let TP_decisions_stored = [0, 0, 0, 0]; // Array to store selected values for each row
    let TP_norm_decisions_stored = [0, 0, 0, 0]; // Array to store selected values for each row
    let TP_neg_norm_decisions_stored = [0, 0, 0, 0];

    var current_treatment = "{{ treatment }}";
    //console.log("Current treatment:", current_treatment );

    const TP_points = {{ C.TP_points }}; // third party points
    const TP_eff = {{ C.TP_effectiveness }}; // punishment or reward or victim compensation effectiveness
    const TP_cost = {{ C.TP_cost }}; // cost to the third party for punish or reward or compensation

    const TP_decisions = {{ TP_decisions | safe }};
    const TP_norm_decisions = {{ TP_norm_decisions | safe }};
    //console.log('TP decisions:', {{ TP_decisions | safe }});
    //console.log('Norm decisions:', {{ TP_norm_decisions | safe }});

    // Store last clicked row type
    let lastClickedRowType = null;
    let lastClickedIndex = null;
    let lastClickedValue = 0;

    /// Function for showing customized error messages
    var error3 = "{{ error3 }}";

    const errorDiv = document.querySelector('.otree-form-errors');

    if (errorDiv) {
        errorDiv.textContent = error3
    }


/////////// All the functions (for TP_decisions) related to hovering and coinstacks/labels updating
/////////// had to be moved out of the large parent function.

    // function to update the coin stack (TP_decisions only)
    function updateCoinStack(value, index, row) {

        const TP_decision = TP_decisions.find((d) => d.index === parseInt(index, 10));

        TPupdate = TP_points - value// third party updating
        Dupdate = TP_decision.dictator_keeps - (value* TP_eff) // dictator updating
        DesRupdate = value* TP_eff // destruction and reward updating
        Cupdate = value* TP_eff // compensation updating

        if (Dupdate < 0 && (current_treatment.includes("punish") || current_treatment.includes("3PP country") || current_treatment.includes("comp"))) { // if Dupdate is less than 0 & we are in punishment condition
            DesRupdate = DesRupdate + Dupdate // Set DesRupdate to max endowment (not more)
            Dupdate = 0; // Set Dupdate to 0 if it's less than 0
        }

        if (current_treatment.includes("reward")) { // leave dictator coins if 3PR
            Dupdate = TP_decision.dictator_keeps
        }

        // Only updates in TP decision condition
        if (!current_treatment.includes("norm") ) {
            // Clear existing stacks
            if (row === "punish") {
                $(`.coinstackTP[data-index="${index}"]`).empty();
                //console.log('Cleared coinstackTP for index:', index);
                $(`.coinstackD[data-index="${index}"]`).empty();
                //console.log('Cleared coinstackD for index:', index);
                $(`.coinstackDDes[data-index="${index}"]`).empty();
                $(`.coinstackDDes2PP[data-index="${index}"]`).empty();
                //console.log('Cleared coinstackDDes for index:', index);
                $(`.coinstackTP2PP[data-index="${index}"]`).empty();
                $(`.coinstackTP3PR[data-index="${index}"]`).empty();
            }
            if (row === "compensate") {
                $(`.coinstackTP3PC[data-index="${index}"]`).empty();
            }

            // Add the specified number of coins
            if (row === "punish") { // prevent the punishment stacks update in compensation treatments only
                for (let i = 0; i < TPupdate; i++) {
                    $(`.coinstackTP[data-index="${index}"]`).append('<div class="coinown" style="left:75%;"></div>');
                }

                for (let i = 0; i < Dupdate; i++) {
                    $(`.coinstackD[data-index="${index}"]`).append('<div class="coin" style="left:calc(50% - 63px);"></div>');
                }

                for (let i = 0; i < DesRupdate; i++) {
                    $(`.coinstackDDes[data-index="${index}"]`).append('<div class="coin_destroyed" style="left:calc(50% - 90px);"></div>');
                }
            }

            // Update other stacks for subconditions: 2PP, 2PR, 3PC
            for (let i = 0; i < TPupdate; i++) {
                $(`.coinstackTP2PP[data-index="${index}"]`).append('<div class="coinown2PP" style="left:83%;"></div>');
            }

            for (let i = 0; i < DesRupdate; i++) {
                $(`.coinstackTP3PR[data-index="${index}"]`).append('<div class="coinown3PR" style="left:7%;"></div>');
            }

            for (let i = 0; i < Cupdate; i++) {
                $(`.coinstackTP3PC[data-index="${index}"]`).append('<div class="coinown3PC" style="left:102%;"></div>');
            }

            for (let i = 0; i < DesRupdate; i++) {
                $(`.coinstackDDes2PP[data-index="${index}"]`).append('<div class="coin_destroyed2PP" style="left:calc(50% - 2px)"></div>');
            }

            // Update the number labels
            if (row === "punish") {
                $(`#countTP[data-index="${index}"]`).text(`${TPupdate}`);
                //console.log('coin number for index:', index);
                $(`#countD[data-index="${index}"]`).text(`${Dupdate}`);
                $(`#countDDes[data-index="${index}"]`).text(`${DesRupdate}`);
                $(`#countDDes2PP[data-index="${index}"]`).text(`${DesRupdate}`);
                $(`#countTP2PP[data-index="${index}"]`).text(`${TPupdate}`);
                $(`#countTP3PR[data-index="${index}"]`).text(`${DesRupdate}`);
            }
            if (row === "compensate") {
                $(`#countTP3PC[data-index="${index}"]`).text(`${Cupdate}`);
            }
        }

        //Debugging
        //console.log(`updateCoinStack called - Count: ${count}, Index: ${index}, Row: ${row}`);
        //console.log(`Calculated TPupdate: ${TPupdate}, Dupdate: ${Dupdate}, DesRupdate: ${DesRupdate}`);
    }

    // Hover function calling updateCoinStack - Updates the hovered row and resets the other row
    $(document).on('mouseenter', '.number', function () {
        const value = $(this).data('value');  // Get number value
        const index = $(this).data('index');  // Get the index
        const row = $(this).closest('.number-row-comp').length ? "compensate" : "punish"; // Detect row type

        //console.log('Hover triggered. Value:', value, 'Index:', index, 'Row:', row);

        // Update the hovered stack
        updateCoinStack(value, index, row);

        // Reset the other stack while hovering
        const otherRow = row === "punish" ? "compensate" : "punish";
        updateCoinStack(0, index, otherRow);
    });

    // Restore function - Ensures only one stack stays updated after hovering
    function restoreRowState(index) {
        if (lastClickedRowType && lastClickedIndex === index) {
            updateCoinStack(lastClickedValue, index, lastClickedRowType); // Restore clicked stack
            updateCoinStack(0, index, lastClickedRowType === "punish" ? "compensate" : "punish"); // Reset other stack
            //console.log(`Restoring last clicked stack: ${lastClickedRowType} at index ${index}`);
        } else {
            // Reset both if nothing was clicked
            updateCoinStack(0, index, "punish");
            updateCoinStack(0, index, "compensate");
            //console.log(`Resetting both stacks at index ${index}`);
        }
    }

    // Mouse leave function - Ensures only one updated stack remains
    $(document).on('mouseleave', '.number-row, .number-row-comp', function () {
        const index = $(this).data('index');
        restoreRowState(index);
    });


////////////// function for displaying the task, numbers, and labels and managing the click event
    $(document).ready(function () {

        TP_decision_effect = 0 // dictator or recipient points that are destroyed by punishment or added by reward/compensation

        // country pictures from https://github.com/irixapps/World-Flags/tree/master
        // naming convention: https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2

        receiverCountry = "{{ recip_identity }}"
        dictatorCountry = "{{ dic_identity }}"

        if (receiverCountry == "out") {
            receiverCountryName = "one of 40 countries"
        }


        /////////////// script

        // get flags
        $('.receiver-flag').attr('src', '/static/global/flags/' + receiverCountry +'.png');
        $('.dictator-flag').attr('src', '/static/global/flags/' + dictatorCountry +'.png');

        // get maps
        $('.receiver-map').attr('src', '/static/global/worldmap/' + receiverCountry +'.png');
        $('.dictator-map').attr('src', '/static/global/worldmap/' + dictatorCountry +'.png');


        // only in TP_decision conditions
        if (!current_treatment.includes("norm") ) {

            // Initialize coin stacks for each TP decision
            TP_decisions.forEach((TP_decision) => {
                const index = TP_decision.index;
                const dictatorKeeps = TP_decision.dictator_keeps;
                const receiverGets = TP_decision.receiver;

                // Set the default display text for TP cost
                $(`.TP-cost-display[data-index="${index}"]`).text('_');


                // Fill initial coin stacks
                // dictator stack
                for (let i = 0; i < dictatorKeeps; i++) {
                    $(`.coinstackD[data-index="${index}"]`).append('<div class="coin" style="left:calc(50% - 63px);"></div>');
                }
                // red stack (destructed coins)
                for (let i = 0; i < TP_decision_effect; i++) {
                    $(`.coinstackDDes[data-index="${index}"]`).append('<div class="coinown" style="left:calc(50% - 90px)"></div>></div>');
                }
                // punisher stack
                for (let i = 0; i < TP_points; i++) {
                    $(`.coinstackTP[data-index="${index}"]`).append('<div class="coinown" style="left:75%;"></div>></div>');
                }
                // receiver stack
                for (let i = 0; i < receiverGets; i++) {
                    $(`.coinstackR[data-index="${index}"]`).append('<div class="coinR" style="left:calc(50% - 2px)"></div>');
                }

                // Extra stacks in different locations
                // punisher in 2PP punisher stack
                for (let i = 0; i < TP_points; i++) {
                    $(`.coinstackTP2PP[data-index="${index}"]`).append('<div class="coinown2PP" style="left:83%;"></div>');
                }
                // DG reward in 3PR
                for (let i = 0; i < TP_decision_effect; i++) {
                    $(`.coinstackTP3PR[data-index="${index}"]`).append('<div class="coinown3PR" style="left:7%;"></div>');
                }
                // recipient compensation in 3PC
                for (let i = 0; i < TP_decision_effect; i++) {
                    $(`.coinstackTP3PC[data-index="${index}"]`).append('<div class="coinown3PC" style="left:102%;"></div>');
                }
                // Destroyed coins 2PP
                for (let i = 0; i < TP_decision_effect; i++) {
                    $(`.coinstackDDes2PP[data-index="${index}"]`).append('<div class="coinown" style="left:calc(50% - 63px)"></div>></div>');
                }


                // Initialize number labels
                $('#countTP[data-index="' + index + '"]').text(`${TP_points}`);
                $('#countD[data-index="' + index + '"]').text(`${dictatorKeeps}`);
                $('#countR[data-index="' + index + '"]').text(`${receiverGets}`);
                $('#countTP2PP[data-index="' + index + '"]').text(`${TP_points}`);
                // You can also initialize other labels like countDDes, countTP3PR, etc. if needed
                $('#countDDes[data-index="' + index + '"]').text(`${TP_decision_effect}`);
                $('#countDDes2PP[data-index="' + index + '"]').text(`${TP_decision_effect}`);
                $('#countTP3PR[data-index="' + index + '"]').text(`${TP_decision_effect}`);
                $('#countTP3PC[data-index="' + index + '"]').text(`${TP_decision_effect}`);
            });

            // deactive punishment that would generate negative values
            let numbersToDisable = [];
            TP_decisions.forEach(TP_decision => {
                // Calculate the maximum punishment value possible based on the dictator's kept coins
                DPpossible = Math.ceil(TP_decision.dictator_keeps / TP_eff);

                // Generate the numbers that should be disabled (punishment numbers that exceed possible value)
                for (let i = DPpossible + 1; i <= TP_points; i++) {
                    numbersToDisable.push(i); // Add all numbers that are larger than the max possible punishment value
                }

                // Only deactivate numbers in the "punish" row for specific treatments (including "3PC comp")
                if (current_treatment.includes("punish") || current_treatment.includes("3PC comp") || current_treatment.includes("3PP country")) {
                    // Ensure we only disable punishment numbers for the "punish" row
                    deactivateNumbers(numbersToDisable, TP_decision.index, "punish");
                }
            });

            // Formatting function to display TP cost nicely
            function formatNumber(num) {
                return Number.isInteger(num) ? num.toString() : num.toFixed(2);
            }

            // Click function - Stores last clicked stack and updates accordingly
            $('.number').on('click', function () {
                // Remove 'selected' class from all buttons
                $(this).closest('.numbers').find('.number').removeClass('selected');

                // Add 'selected' class to the clicked button
                $(this).addClass('selected');

                // Get values
                const value = $(this).data('value');
                const index = $(this).data('index');
                const row = $(this).closest('.number-row-comp').length ? "compensate" : "punish";

                // Update the corresponding punishment value in the array
                //TP_decisions_stored[index - 1] = value;

                // Update the hidden input field
                $(`#selected-number-${index}`).val(value);

                // Update the hidden input field for the selected action
                let rowValue = row === "punish" ? 0 : 1; //because integer in python
                $("#selected-action-" + index).val(rowValue);

                // Store clicked values
                lastClickedRowType = row;
                lastClickedIndex = index;
                lastClickedValue = value;

                costTP = formatNumber(value / TP_cost)

                // Update the display text for TP cost
                $(`.TP-cost-display[data-index="${index}"]`).text(costTP);

                // Update the clicked stack
                updateCoinStack(value, index, row);

                // Reset the other stack
                const otherRow = row === "punish" ? "compensate" : "punish";
                updateCoinStack(0, index, otherRow);

                console.log(`Clicked decision at index ${index} (${row}): ${value}`);
                //console.log(`Punishment values: ${TP_decisions_stored}`);
                //console.log(`After updating input: #selected-number-${index}, value:`, $(`#selected-number-${index}`).val()); // Log updated value

            });
        }

        // Fill initial coin stacks and number labels for each TP NORM question
        // Also includes response collection (different function for TP decision)
        if (current_treatment.includes("norm") ) { // in norm condition

            // Is this for the text?
            //document.getElementById("norm_fixed_amount").textContent = norm_fixed_amount;

            TP_norm_decisions.forEach((TP_norm_decision) => {
                const index = TP_norm_decision.index;
                let dictatorKeeps = TP_norm_decision.dictator_keeps;
                const receiverGets = TP_norm_decision.receiver;
                const norm_TP_points = {{ C.norm_fixed_TP_points }}

                // leave dictator coins if 3PR or 3PC, remove the norm_TP_points if 2PP or 3PP
                // Update: We are NOT displaying updated coin stacks for 3PP/2PP norms!
                dictatorKeeps = TP_norm_decision.dictator_keeps
                // if (current_treatment.includes("reward") || current_treatment.includes("comp")) {
                //     dictatorKeeps = TP_norm_decision.dictator_keeps
                // } else if (current_treatment.includes("punish") || current_treatment.includes("3PP country")) {
                //     dictatorKeeps = TP_norm_decision.dictator_keeps-norm_TP_points
                // }

                    // dictator stack
                    for (let i = 0; i < dictatorKeeps; i++) {
                        $(`.coinstackD[data-index="${index}"]`).append('<div class="coin" style="left:calc(50% - 63px);"></div>');
                    }
                    // red stack (destructed coins)
                    for (let i = 0; i < norm_TP_points; i++) {
                        $(`.coinstackDDes[data-index="${index}"]`).append('<div class="coin_destroyed" style="left:calc(50% - 20px);"></div>');
                    }
                    // punisher stack
                    for (let i = 0; i < norm_TP_points; i++) {
                        $(`.coinstackTP[data-index="${index}"]`).append('<div class="coinown" style="left:75%;"></div>></div>');
                    }
                    // receiver stack
                    for (let i = 0; i < receiverGets; i++) {
                        $(`.coinstackR[data-index="${index}"]`).append('<div class="coinR" style="left:calc(50% - 2px)"></div>');
                    }

                    // Extra stacks in different locations
                    // punisher in 2PP punisher stack
                    for (let i = 0; i < TP_points; i++) {
                        $(`.coinstackTP2PP[data-index="${index}"]`).append('<div class="coinown2PP" style="left:83%;"></div>');
                    }
                    // DG reward in 3PR
                    for (let i = 0; i < TP_points; i++) {
                        $(`.coinstackTP3PR[data-index="${index}"]`).append('<div class="coinown3PR" style="left:7%;"></div>');
                    }
                    // recipient compensation in 3PC
                    for (let i = 0; i < TP_points; i++) {
                        $(`.coinstackTP3PC[data-index="${index}"]`).append('<div class="coinown3PC" style="left:102%;"></div>');
                    }
                    // destroyed coins for 2PP
                    for (let i = 0; i < norm_TP_points; i++) {
                        $(`.coinstackDDes2PP[data-index="${index}"]`).append('<div class="coin_destroyed2PP" style="left:calc(50% - 2px)"></div>');
                    }

                    // number labels
                    $('#countTP[data-index="' + index + '"]').text(`${norm_TP_points}`);
                    $('#countD[data-index="' + index + '"]').text(`${dictatorKeeps}`);
                    $('#countR[data-index="' + index + '"]').text(`${receiverGets}`);
                    $('#countTP2PP[data-index="' + index + '"]').text(`${norm_TP_points}`);
                    $('#countDDes[data-index="' + index + '"]').text(`${norm_TP_points}`);
                    $('#countDDes2PP[data-index="' + index + '"]').text(`${norm_TP_points}`);
                    $('#countTP3PR[data-index="' + index + '"]').text(`${norm_TP_points}`);
                    $('#countTP3PC[data-index="' + index + '"]').text(`${norm_TP_points}`);

                    //Debugging
                    //console.log('Dictator stack - Index:', index, 'Coins:', dictatorKeeps);
                    //console.log('Receiver stack - Index:', index, 'Coins:', receiverGets);
                    //console.log('Norm fixed amount - Index:', index, 'Effect:', norm_fixed_amount);

            });

            // Collect responses for each separate question
            $('.norm').on('click', function () {
                // Remove 'selected' class from all buttons
                $(this).closest('.number-row').find('.norm').removeClass('selected');

                // Add 'selected' class to the clicked button
                $(this).addClass('selected');

                // Get the value of the clicked button
                const value = $(this).data('value');
                const index = $(this).data('index');

                // Update the corresponding punishment value in the array
                TP_norm_decisions_stored[index - 1] = value;

                // Update the hidden input field
                $(`#selected-norm-${index}`).val(value);

                // Debugging
                //console.log(`Updated norm decision at index ${index}: ${value}`);
                //console.log(`Norm values: ${TP_norm_decisions_stored}`);
            });

            $('.neg-norm').on('click', function () {
                // Remove 'selected' class from all buttons
                $(this).closest('.number-row').find('.neg-norm').removeClass('selected');

                // Add 'selected' class to the clicked button
                $(this).addClass('selected');

                // Get the value of the clicked button
                const value = $(this).data('value');
                const index = $(this).data('index');

                // Update the corresponding punishment value in the array
                TP_neg_norm_decisions_stored[index - 1] = value;

                // Update the hidden input field
                $(`#selected-neg-norm-${index}`).val(value);

                // Debugging
                //console.log(`Updated norm decision at index ${index}: ${value}`);
                //console.log(`neg Norm values: ${TP_neg_norm_decisions_stored}`);
            });
        }

        function deactivateNumbers(numbersToDisable, index, row) {
        // Only deactivate numbers for the "punish" row
            numbersToDisable.forEach(num => {
                // Add 'disabled' class to numbers that are not allowed for the "punish" row
                $('.number[data-value="' + num + '"][data-index="' + index + '"][data-row="punish"]').addClass('disabled');  // Target only the "punish" row numbers
            });
        }

        // Submit button click handler
        $('#submit-button').on('click', function () {
            // // Submit the form
            // $('form').submit();

            var error3 = "{{ error3 }}";

            if (current_treatment.includes("norm") ) {

                // Get the values of the two form fields
                let norm1 = $(`#selected-norm-${1}`).val();
                let norm2 = $(`#selected-neg-norm-${1}`).val();

                // Check if either field is empty
                if (!norm1 || !norm2) {
                    alert(error3);
                } else {
                    // Submit the form if both fields have values
                    $('form').submit();
                }
            } else {
                // Get the values of the three form fields
                let tp1 = $(`#selected-number-${1}`).val();
                let tp2 = $(`#selected-number-${2}`).val();
                let tp3 = $(`#selected-number-${3}`).val();

                // Check if either field is empty
                if (!tp1 || !tp2 || !tp3) {
                    alert(error3);
                } else {
                    // Submit the form if both fields have values
                    $('form').submit();
                }
            }

        });

    });


    ///////// Template rendering
    document.addEventListener("DOMContentLoaded", () => {
        const tpDecisionTemplate = {{ tpp_dict_action|json }};
        TP_decisions.forEach(decision => {
            const sentence = tpDecisionTemplate
                .replace("{receiver}", decision.receiver)
                .replace("{dictator_keeps}", decision.dictator_keeps);

            const el = document.getElementById("sentence-" + decision.index);
            if (el) el.innerHTML = sentence;
        });

        const tpNormTemplate = {{ tpp_dict_action|json }};
        TP_norm_decisions.forEach(norm_decision => {
            const norm_sentence = tpNormTemplate
                .replace("{receiver}", norm_decision.receiver)
                .replace("{dictator_keeps}",  norm_decision.dictator_keeps);

            const el = document.getElementById("norm-sentence-" + norm_decision.index);
            if (el) el.innerHTML = norm_sentence;
        });

        const tpCostTemplate = {{ tpp_decision_cost|json }};
        TP_decisions.forEach(decision => {
            const cost_sentence = tpCostTemplate
                .replace("{index}", decision.index)

            const el = document.getElementById("cost-sentence-" + decision.index);
            if (el) el.innerHTML = cost_sentence;
        });
    })


</script>
</head>


<body>

    <form method="post">

    {% if "norm" in player.treatment %}

        <input type="hidden" name="TP_norm_decision1" id="selected-norm-1">


<!--        {{ formfield_errors 'TP_norm_decision1' }}-->

            {% if "punish" in player.treatment or "reward" in player.treatment %}

            <input type="hidden" name="TP_neg_norm_decision1" id="selected-neg-norm-1">
<!--            {{ formfield_errors 'TP_neg_norm_decision1' }}-->

            {% endif %}

    {% else %}

        <!-- Add hidden input to store the selected value -->
        <input type="hidden" name="TP_decision1" id="selected-number-1">
        <input type="hidden" name="TP_decision2" id="selected-number-2">
        <input type="hidden" name="TP_decision3" id="selected-number-3">

<!--        {{ formfield_errors 'TP_decision1' }}-->
<!--        {{ formfield_errors 'TP_decision2' }}-->
<!--        {{ formfield_errors 'TP_decision3' }}-->

        {% if "comp" in player.treatment %}

        <input type="hidden" name="punish_or_compensate1" id="selected-action-1">
        <input type="hidden" name="punish_or_compensate2" id="selected-action-2">
        <input type="hidden" name="punish_or_compensate3" id="selected-action-3">
<!--            {{ formfield_errors 'punish_or_compensate1' }}-->
<!--            {{ formfield_errors 'punish_or_compensate2' }}-->
<!--            {{ formfield_errors 'punish_or_compensate3' }}-->

        {% endif %}

    {% endif %}


    {% if "norm" in player.treatment %}

        {% if "2PP" in player.treatment and player.round_number < 6 %}
            <p style="text-align: center;">
                <b> {{ tpp_2PP_norm_instru }}</b>
                <br><br>
                {{ tpp_2PP_norm_incentive }}
                <br><br>
            </p>
        {% endif %}

        {% if "3PP" in player.treatment or "3PR" in player.treatment or "3PC" in player.treatment %}
            <p style="text-align: center;">
                <b> {{ tpp_3PP_norm_instru }}</b>
                <br><br>
            </p>
        {% endif %}

        <div style="text-align: center;">
            {% if "country" in player.treatment or "IN" in player.treatment or "OUT" in player.treatment %}
                {{ tpp_countries }}
            {% endif %}
        </div>

        {% if dic_identity != "baseline"%}
            <br>
        {% endif %}

        {% for TP_norm_decision in TP_norm_decisions %}

        <div class='responsive-div'>
            {% if "2PP" in player.treatment %}
                <br>
            {% endif %}
            <div class="figure-container {% if '2PP' in player.treatment %}short-figure-container{% endif %}" data-index="{{ TP_norm_decision.index }}">

                {% if dic_identity != "baseline"%}
                    <img src="" alt='country flag' class='receiver-flag'>
                    <img src="" alt='country flag' class='dictator-flag'>

                    <img src="" alt='position of country on a map' class='receiver-map'>
                    <img src="" alt='position of country on a map' class='dictator-map'>
                {% endif %}

                <img class="scenario_image" alt="figure with characters giving or receiver coins" src="/static/{{ image }}">

                <div class="person-a">
                    <b>{{ person_a }}</b>
                </div>
                <div class="person-b">
                    <b>{{ person_b }}</b>
                </div>

                {% if "3PP" in player.treatment or "3PR" in player.treatment or "3PC" in player.treatment %}
                    <div class="person-c">
                    <b>{{ person_c }}</b>
                </div>
                {% endif %}

                <span class='coinstack coinstackD' data-index="{{ TP_norm_decision.index }}"></span>
                <div class="coin-count-labelD" id="countD" data-index="{{ TP_norm_decision.index }}"></div>

                <span class='coinstack coinstackR' data-index="{{ TP_norm_decision.index }}"></span>
                <div class="coin-count-labelR" id="countR" data-index="{{ TP_norm_decision.index }}"></div>


<!--                {% if "punish" in player.treatment %}-->
<!--                    <span class='coinstack coinstackDDes'-->
<!--                      style="{% if '2PP' in player.treatment %}top: 55%;{% endif %}"-->
<!--                          data-index="{{ TP_norm_decision.index }}"></span>-->
<!--                    <div class="coin-count-labelDDes" id="countDDes" data-index="{{ TP_norm_decision.index }}"></div>-->
<!--                {% endif %}-->

<!--                {% if "reward" in player.treatment %}-->
<!--                    <span class='coinstack coinstackTP3PR' data-index="{{ TP_norm_decision.index }}"></span>-->
<!--                    <div class="coin-count-labelTP3PR" id="countTP3PR" data-index="{{ TP_norm_decision.index }}"></div>-->
<!--                {% endif %}-->

<!--                {% if "comp" in player.treatment %}-->
<!--                    <span class='coinstack coinstackTP3PC' data-index="{{ TP_norm_decision.index }}"></span>-->
<!--                    <div class="coin-count-labelTP3PC" id="countTP3PC" data-index="{{ TP_norm_decision.index }}"></div>-->
<!--                {% endif %}-->

                {% if "3PP" in player.treatment or "3PC" in player.treatment %}
                    <img class="minus-button-3PP" src="/static/global/minus_button2.png" alt="-">
                {% endif %}

                {% if "3PR" in player.treatment %}
                    <img class="plus-button-3PR" src="/static/global/plus_button.png" alt="+">
                {% endif %}

                {% if "3PC" in player.treatment %}
                    <img class="plus-button-3PC" src="/static/global/plus_button.png" alt="+">
                {% endif %}

                {% if "2PP" in player.treatment %}
                    <img class="minus-button-2PP" src="/static/global/minus_button2.png" alt="-" style="top: -50px;">
                    <img class="punish-arrow-2PP" src="/static/global/punish arrow grey.png" alt="-">
                {% endif %}

            </div>

            <div id="norm-sentence-{{ TP_norm_decision.index }}" style="text-align: center; font-size: 14px; margin-bottom: 20px">
                {{ tpp_dict_action }}
            </div>

            <p style="text-align: center;">
                <strong>{{ tpp_norm_question|safe }}</strong>
            </p>

            <div class='numbers'>
                <div class="number-row" data-index="{{ TP_norm_decision.index }}" data-input="selected-norm-{{ TP_norm_decision.index }}">
                    <div class="norm" data-value="0" data-index="{{ TP_norm_decision.index }}">{{ very_inappropriate }}</div>
                    <div class="norm" data-value="1" data-index="{{ TP_norm_decision.index }}">{{ inappropriate }}</div>
                    <div class="norm" data-value="2" data-index="{{ TP_norm_decision.index }}">{{ slightly_inappropriate }}</div>
                    <div class="norm" data-value="3" data-index="{{ TP_norm_decision.index }}">{{ slightly_appropriate }}</div>
                    <div class="norm" data-value="4" data-index="{{ TP_norm_decision.index }}">{{ appropriate }}</div>
                    <div class="norm" data-value="5" data-index="{{ TP_norm_decision.index }}">{{ very_appropriate }}</div>
                </div>
            </div>

            {% if "punish" in player.treatment or "reward" in player.treatment %}
            <br>

            <p style="text-align: center;">
                <strong>{{ tpp_norm_neg_question|safe }}</strong>
            </p>

            <div class='numbers'>
                <div class="number-row" data-index="{{ TP_norm_decision.index }}" data-input="selected-neg-norm-{{ TP_norm_decision.index }}">
                    <div class="neg-norm" data-value="0" data-index="{{ TP_norm_decision.index }}">{{ very_inappropriate }}</div>
                    <div class="neg-norm" data-value="1" data-index="{{ TP_norm_decision.index }}">{{ inappropriate  }}</div>
                    <div class="neg-norm" data-value="2" data-index="{{ TP_norm_decision.index }}">{{ slightly_inappropriate  }}</div>
                    <div class="neg-norm" data-value="3" data-index="{{ TP_norm_decision.index }}">{{ slightly_appropriate }}</div>
                    <div class="neg-norm" data-value="4" data-index="{{ TP_norm_decision.index }}">{{ appropriate }}</div>
                    <div class="neg-norm" data-value="5" data-index="{{ TP_norm_decision.index }}">{{ very_appropriate }}</div>
                </div>
            </div>
            {% endif %}
        <br>
        <hr>
        <br>
        <br>
        </div>
        {% endfor %}


    {% else %}

        {% if "2PP" in player.treatment %}
        <div style="text-align: center; margin-bottom: 60px;">
            <b style="color: red; ">{{ tpp_decision_you }}</b>
            <br>
            {{ tpp_decision_strategy }}
        </div>
        {% endif %}

        {% if "3PP" in player.treatment or "3PR" in player.treatment or "3PC" in player.treatment %}
        <div style="text-align: center; margin-bottom: 20px;">
            <b style="color: red; ">{{ tpp_decision_you }}</b>
            <br>
            {{ tpp_decision_strategy }}
        </div>
        {% endif %}

        <div style="text-align: center;">
            {% if "country" in player.treatment or "IN" in player.treatment or "OUT" in player.treatment %}
                {{ tpp_countries }}
            {% endif %}
        </div>

        {% if dic_identity != "baseline"%}
            <br><br>
        {% endif %}

        {% for TP_decision in TP_decisions %}
        <br>
        <div class='responsive-div'>
            <div class="figure-container {% if '2PP' in player.treatment %}short-figure-container{% endif %}" data-index="{{ TP_decision.index }}">

                {% if dic_identity != "baseline"%}
                    <img src="" alt='country flag' class='receiver-flag'>
                    <img src="" alt='country flag' class='dictator-flag'>

                    <img src="" alt='position of country on a map' class='receiver-map'>
                    <img src="" alt='position of country on a map' class='dictator-map'>
                {% endif %}

                <img class="scenario_image" alt="figure with characters giving or receiver coins" src="/static/{{ image }}">

                <div class="person-a">
                    <b>{{ person_a }}</b>
                </div>
                <div class="person-b">
                    <b>{{ person_b }}</b>
                </div>

                {% if "3PP" in player.treatment or "3PR" in player.treatment or "3PC" in player.treatment %}
                <div class="person-c">
                    <b>{{ person_c }}</b>
                </div>

                <div class="you-third-party">
                    <b>{{ you }}</b>
                </div>
                {% endif %}

                {% if "2PP" in player.treatment %}
                <div class="you-receiver">
                    <b>{{ you }}</b>
                </div>
                {% endif %}

                <span class='coinstack coinstackD' data-index="{{ TP_decision.index }}"></span>
                <div class="coin-count-labelD" id="countD" data-index="{{ TP_decision.index }}"></div>

                <span class='coinstack coinstackR' data-index="{{ TP_decision.index }}"></span>
                <div class="coin-count-labelR" id="countR" data-index="{{ TP_decision.index }}"></div>


                {% if "3PP" in player.treatment or "3PC" in player.treatment %}
                    <span class='coinstack coinstackDDes' data-index="{{ TP_decision.index }}"></span>
                    <div class="coin-count-labelDDes" id="countDDes" data-index="{{ TP_decision.index }}"></div>
                {% endif %}

                {% if "2PP" in player.treatment %}
                    <span class='coinstack coinstackDDes2PP' data-index="{{ TP_decision.index }}"></span>
                    <div class="coin-count-labelDDes2PP" id="countDDes2PP" data-index="{{ TP_decision.index }}"></div>
                {% endif %}

                {% if "reward" in player.treatment %}
                    <span class='coinstack coinstackTP3PR' data-index="{{ TP_decision.index }}"></span>
                    <div class="coin-count-labelTP3PR" id="countTP3PR" data-index="{{ TP_decision.index }}"></div>
                {% endif %}

                {% if "comp" in player.treatment %}
                    <span class='coinstack coinstackTP3PC' data-index="{{ TP_decision.index }}"></span>
                    <div class="coin-count-labelTP3PC" id="countTP3PC" data-index="{{ TP_decision.index }}"></div>
                {% endif %}

                {% if "3PP" in player.treatment or "3PC" in player.treatment %}
                    <img class="minus-button-3PP" src="/static/global/minus_button2.png" alt="-">
                {% endif %}

                {% if "3PR" in player.treatment %}
                    <img class="plus-button-3PR" src="/static/global/plus_button.png" alt="+">
                {% endif %}

                {% if "3PC" in player.treatment %}
                    <img class="plus-button-3PC" src="/static/global/plus_button.png" alt="+">
                {% endif %}

                {% if "2PP" in player.treatment %}
                    <img class="minus-button-2PP" src="/static/global/minus_button2.png" alt="-">
                    <img class="punish-arrow-2PP" src="/static/global/punish arrow grey.png" alt="-">
                {% endif %}

            </div>

            <div id="sentence-{{ TP_decision.index }}" style="text-align: center; font-size: 14px; margin-bottom: 20px">
                {{ tpp_dict_action }}
            </div>

            <div class='numbers'>
                <p style="text-align: center; font-weight: bold">{{ tpp_decision_question }}</p>

                <div class="number-row" data-index="{{ TP_decision.index }}" data-row="punish" data-input="selected-number-{{ TP_decision.index }}">
                    {{ for num in TP_points }}
                    <div class="number" data-value="{{ num }}" data-row="punish" data-index="{{ TP_decision.index }}">{{ num }}</div>
                    {{ endfor }}
                </div>
                {% if "3PC" in player.treatment%}
                <br>

                <p style="text-align: center; ">
                    <b>OR</b>
                </p>

                <p style="text-align: center; "> <strong>How many points do you <b style="color: green;"> {{ treatment_text_action_comp }}  {{ treatment_text_receiver_comp }}</b> ? </strong> </p>

                <div class="number-row-comp" data-index="{{ TP_decision.index }}" data-row="compensate" data-input="selected-number-{{ TP_decision.index }}">
                    {{ for num in TP_points }}
                    <div class="number" data-value="{{ num }}" data-row="compensate" data-index="{{ TP_decision.index }}">{{ num }}</div>
                    {{ endfor }}
                </div>
                {% endif %}
            </div>

            <div id="cost-sentence-{{ TP_decision.index }}" style="text-align: center;">
                {{ tpp_decision_cost }}
            </div>
        <br>
        <hr>
        </div>

        {% if dic_identity != "baseline" or "2PP" in player.treatment%}
            <br><br>
        {% endif %}

        {% endfor %}

    {% endif %}

    <div class="button-container">
        <button type="button" id="submit-button" class="submit-button">
            {{ button_next|safe }}
        </button>
    </div>

</form>

</body>
</html>



{{ endblock }}
