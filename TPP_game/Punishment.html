{{ block title }}

Round {{ subsession.round_number }}

{{ endblock }}

{{ block styles }}

<style>

    body {
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin-top: 4vw;
        background-color: #f4f4f4;
    }

    .number-row {
        justify-content: center;
          display: flex;
          margin-top:3vw;
          gap: 1vw; /* Space between numbers scales with viewport width */
    }

    .number {
        width: 3vw; /* Width scales with viewport width */
        height: 3vw; /* Height scales with viewport width */
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.5vw; /* Font size scales with viewport width */
        background-color: #e0e0e0;
        border: 2px solid #000000;
        border-radius: 10%; /* Slightly rounded corners */
        cursor: pointer;
        font-family: Arial, Helvetica, sans-serif;
        transition: background-color 0.3s ease;
    }

    .number:hover {
        background-color: #ffcc00; /* Change background color on hover */
    }

    .number:active {
        background-color: #ffa500; /* Change background color on click */
    }

    .number.selected {
             background-color: #ffa500; /* Permanent color when clicked */
    }

    .number.disabled {
        background-color: #F3F3F3; /* Grey color for disabled buttons */
        border: 2px solid #d3d3d3;
        color:#d3d3d3;
        cursor: not-allowed;
        pointer-events: none; /* Disable interactions */
    }

    .responsive-div {
      width: 90%; /* Default width */
      transform-origin: top left; /* Ensure scaling starts from top-left */
      transform: scale(1); /* Default scale */
      transition: transform 0.3s ease; /* Smooth scaling */
      /*border:1px solid black;*/
      margin-left:auto;
      margin-right:auto;
    }

    .container {
        width:45%;
        height:25vw;
        margin-left:auto;
        margin-right:auto;
        border:0px solid black;
        position:relative;
    }

    @media (max-width: 1200px) {
      .responsive-div {
        transform: scale(1.0); /* Scale to 80% for smaller screens */
      }
      .container {
          margin-left:10vw;
      }
      .numbers {
          position:absolute;
          transform: scale(0.95);
          left:6vw;
      }
    }

    @media (max-width: 800px) {
      .responsive-div {
        transform: scale(2); /* Scale to 60% for even smaller screens */
      }
      .container {
          margin-left:1vw;
      }
      .numbers {
          position:absolute;
          transform: scale(0.95);
          left:-3.2vw;
      }
      .number {
          font-size:2vw;
          border-width:1px;
      }
    }

    .coin-stack {
        position: absolute;
        width: 5vw; /* The stack width adjusts to 20% of the viewport width */
        max-width: 100px; /* Ensure coins don't get too big */
    }

    .coin {
        width: 1.8vw; /* Coins take the full width of the stack container */
        min-width:10px;
        height: 8px; /* Coin height is proportional to the width */
        border-radius: 50%;
        background: linear-gradient(145deg, #ffd700, #e6c200);
        border: 0.1vw solid #FFFFFF; /* Border size scales with the coin size */
        box-shadow: inset -3px -2px 5px rgba(0, 0, 0, 0.2);
        position: absolute;
        transform: translateX(-50%);
    }

    .coinown {
        width: 1.8vw; /* Coins take the full width of the stack container */
        min-width:10px;
        height: 8px; /* Coin height is proportional to the width */
        border-radius: 50%;
        background: linear-gradient(145deg, #ffd700, #e6c200);
        border: 0.1vw solid #FFFFFF; /* Border size scales with the coin size */
        box-shadow: inset -3px -2px 5px rgba(0, 0, 0, 0.2);
        position: absolute;
        transform: translateX(-50%);
    }

    .coin:nth-child(30)  { top: 0.6vw; }
    .coin:nth-child(29)  { top: 0.9vw; }
    .coin:nth-child(28)  { top: 1.2vw; }
    .coin:nth-child(27)  { top: 1.5vw; }
    .coin:nth-child(26)  { top: 1.8vw; }
    .coin:nth-child(25)  { top: 2.1vw; }
    .coin:nth-child(24)  { top: 2.4vw; }
    .coin:nth-child(23)  { top: 2.7vw; }
    .coin:nth-child(22)  { top: 3.0vw; }
    .coin:nth-child(21)  { top: 3.3vw; }
    .coin:nth-child(20)  { top: 3.6vw; }
    .coin:nth-child(19)  { top: 3.9vw; }
    .coin:nth-child(18)  { top: 4.2vw; }
    .coin:nth-child(17)  { top: 4.5vw; }
    .coin:nth-child(16)  { top: 4.8vw; }
    .coin:nth-child(15)  { top: 5.1vw; }
    .coin:nth-child(14)  { top: 5.4vw; }
    .coin:nth-child(13)  { top: 5.7vw; }
    .coin:nth-child(12)  { top: 6.0vw; }
    .coin:nth-child(11)  { top: 6.3vw; }
    .coin:nth-child(10)  { top: 6.6vw; }
    .coin:nth-child(9)   { top: 6.9vw; }
    .coin:nth-child(8)   { top: 7.2vw; }
    .coin:nth-child(7)   { top: 7.5vw; }
    .coin:nth-child(6)   { top: 7.8vw; }
    .coin:nth-child(5)   { top: 8.1vw; }
    .coin:nth-child(4)   { top: 8.4vw; }
    .coin:nth-child(3)   { top: 8.7vw; }
    .coin:nth-child(2)   { top: 9.0vw; }
    .coin:nth-child(1)   { top: 9.3vw; }

    .coinown:nth-child(10)  { top: 20.6vw; left:58% }
    .coinown:nth-child(9)   { top: 20.9vw; left:58% }
    .coinown:nth-child(8)   { top: 21.2vw; left:58% }
    .coinown:nth-child(7)   { top: 21.5vw; left:58% }
    .coinown:nth-child(6)   { top: 21.8vw; left:58% }
    .coinown:nth-child(5)   { top: 22.1vw; left:58% }
    .coinown:nth-child(4)   { top: 22.4vw; left:58% }
    .coinown:nth-child(3)   { top: 22.7vw; left:58% }
    .coinown:nth-child(2)   { top: 23.0vw; left:58% }
    .coinown:nth-child(1)   { top: 23.3vw; left:58% }

</style>



{{ endblock }}


{{ block scripts }}

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>

// Move updateCoinStack function to the global scope
function updateCoinStack(count, index) {

    total_endowment = {{ C.total_endowment }}

    const punishmentEffectiveness = {{ C.punishment_effectiveness }};
    const punishmentPoints = {{ C.punishment_points }};
    //console.log('Decisions:', {{ decisions | safe }});
    const decisions = {{ decisions | safe }};


    //console.log('updateCoinStack called with:', { count, index });

    const decision = decisions.find((d) => d.index === parseInt(index, 10));

    const dictatorKeeps = decision.dictator_keeps;
    const TPupdate = punishmentPoints - count;
    const Dupdate = dictatorKeeps - (count * punishmentEffectiveness);

    //console.log('TPupdate:', TPupdate, 'Dupdate:', Dupdate);

    // Clear existing stacks
    $(`.coinstackTP[data-index="${index}"]`).empty();
    //console.log('Cleared coinstackTP for index:', index);

    $(`.coinstackD[data-index="${index}"]`).empty();
    //console.log('Cleared coinstackD for index:', index);

    // Populate updated stacks
    for (let i = 0; i < TPupdate; i++) {
        $(`.coinstackTP[data-index="${index}"]`).append('<div class="coinown"></div>');
        //console.log('Appended coinown to coinstackTP:', i + 1);
    }
    for (let i = 0; i < Dupdate; i++) {
        $(`.coinstackD[data-index="${index}"]`).append('<div class="coin" style="left:19%;"></div>');
        //console.log('Appended coin to coinstackD:', i + 1);
    }

    //console.log('updateCoinStack completed for index:', index);
}

// Hover function calling updateCoinStack
$('.number').hover(function () {
    const value = $(this).data('value'); // Get the number value
    const index = $(this).closest('.container').data('index');

    //console.log('hover triggered. Value:', value, 'Index:', index);
    updateCoinStack(value, index); // Now accessible
});


    $('.number-row').mouseleave(function () {
        const index = $(this).closest('.container').data('index');
        updateCoinStack(punishments, index);
    });



$(document).ready(function () {

    // task variables

    // country pictures from https://github.com/irixapps/World-Flags/tree/master
    // naming convention: https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2
    receiverCountry = '{{ receiver_country }}'
    dictatorCountry = '{{ dictator_country }}'

    total_endowment = {{ C.total_endowment }}

    const punishmentEffectiveness = {{ C.punishment_effectiveness }};
    const punishmentPoints = {{ C.punishment_points }};
    console.log('Decisions:', {{ decisions | safe }});
    const decisions = {{ decisions | safe }};

    // dependent variable
    let punishments = [0, 0, 0, 0]; // Array to store selected values for each row


    /////////
    // script

    // get flags
    $('.receiverCountry').attr('src', 'https://raw.githubusercontent.com/irixapps/World-Flags/refs/heads/master/png1024/' + receiverCountry +'.png');
    $('.dictatorCountry').attr('src', 'https://raw.githubusercontent.com/irixapps/World-Flags/refs/heads/master/png1024/' + dictatorCountry +'.png');

    // get maps
    $('.receiverCountryMap').attr('src', '/static/global/worldmap/' + receiverCountry +'_map.png');
    $('.dictatorCountryMap').attr('src', '/static/global/worldmap/' + dictatorCountry +'_map.png');


    // Initialize coin stacks for each decision
    decisions.forEach((decision) => {
        const index = decision.index;
        const dictatorKeeps = decision.dictator_keeps;
        const receiverGets = decision.receiver;

        // Fill initial coin stacks
        for (let i = 0; i < dictatorKeeps; i++) {
            $(`.coinstackD[data-index="${index}"]`).append('<div class="coin" style="left:19%;"></div>');
        }
        for (let i = 0; i < punishmentPoints; i++) {
            $(`.coinstackTP[data-index="${index}"]`).append('<div class="coinown"></div>');
        }
        for (let i = 0; i < receiverGets; i++) {
            $(`.coinstackR[data-index="${index}"]`).append('<div class="coin" style="left:65%;"></div>');
        }
    });

    function deactivateNumbers(numbersToDisable, index) {
        numbersToDisable.forEach(num => {
            $('.number[data-value="' + num + '"][data-index="' + index + '"]').addClass('disabled');
        });
    }

    // deactivate punishment that would generate negative values
    decisions.forEach(decision => {
        const DPpossible = Math.ceil(decision.dictator_keeps / 3);
        const numbersToDisable = [];

        // Add numbers to disable based on the logic for each decision
        for (let i = DPpossible + 1; i <= punishmentPoints; i++) {
            numbersToDisable.push(i);
        }

        // Deactivate numbers for the current decision
        deactivateNumbers(numbersToDisable, decision.index);
    });

    $('.number').on('click', function () {
        // Remove 'selected' class from all buttons in this row
        $(this).closest('.container').find('.number').removeClass('selected');

        // Add 'selected' class to the clicked button
        $(this).addClass('selected');

        // Get the value of the clicked button
        const value = $(this).data('value');
        const index = $(this).data('index');

        // Update the corresponding punishment value in the array
        punishments[index - 1] = value;

        // Update the hidden input field for this row
        $(`#selected-number-${index}`).val(value);

        // Update the coin stack for this row
        updateCoinStack(value, index);

        // Debugging
        console.log('Index:', index);
        console.log('Value:', value);
        console.log('Decisions:', decisions);
        console.log(`Punishment values: ${punishments}`);
    });

    // Submit button click handler
    $('#submit-button').on('click', function () {
        // Submit the form
        $('form').submit();
    });

});

</script>

{{ endblock }}


{{ block content }}

<form method="post">
    <!-- Add hidden inputs to store the selected values for each row -->
    <input type="hidden" name="decision_1" id="selected-number-1">
    <input type="hidden" name="decision_2" id="selected-number-2">
    <input type="hidden" name="decision_3" id="selected-number-3">
    <input type="hidden" name="decision_4" id="selected-number-4">

    {{ formfield_errors 'decision_1' }}
    {{ formfield_errors 'decision_2' }}
    {{ formfield_errors 'decision_3' }}
    {{ formfield_errors 'decision_4' }}

    {% for decision in decisions %}
    <div class='responsive-div'>
        <div class='container' data-index="{{ decision.index }}">
            <div data-index="{{ decision.index }}" >

                <!---img src="" style='width:50%; position:absolute; right:16vw' class='dictatorCountry'>
                <img src="" style='width:50%; position:absolute; left:16vw' class='receiverCountry'>

                <img src="" style='width:50%; position:absolute; top:7vw; right:22vw' class='dictatorCountryMap'>
                <img src="" style='width:50%; position:absolute; top:7vw; left:22vw' class='receiverCountryMap'--->

                <!---img src = "{{ static 'TPP_game/TPtask.png' }}" style='width:27vw; position:absolute; left:-25%; top:3vw'--->

                <span class='coinstack coinstackD' data-index="{{ decision.index }}"></span>
                <span class='coinstack coinstackR' data-index="{{ decision.index }}"></span>
                <span class='coinstack coinstackTP' data-index="{{ decision.index }}"></span>

            </div>
            <br>
            <div class='numbers'>
                <div class="number-row" data-index="{{ decision.index }}" data-input="selected-number-{{ decision.index }}">
                    {{ for num in punishment_points }}
                    <div class="number" data-value="{{ num }}" data-index="{{ decision.index }}">{{ num }}</div>
                    {{ endfor }}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
    <br>
    <div style="display: flex; justify-content: flex-end">
        <button type="button" id="submit-button">Submit</button>
    </div>
</form>


{{ endblock }}